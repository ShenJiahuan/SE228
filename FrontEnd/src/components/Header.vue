<template>
    <div class="header">
        <div class="header-left">
            <div class="logo">
                <svg version="1.1" id="logo-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px"
                     y="0px" viewBox="0 0 476 96" xml:space="preserve">
    <path d="M90.6,36.3l-5.2-1.9V23.5l5.2-2.2l-35.2-13l-42.8,15c-4.1,2-4.2,7.5-4.2,12c0,1.5,0.2,3,0.5,4.4C5.5,41.9,5.4,47,5.4,51.3
        c0,3.5,0.8,6.7,3,8.7c-0.5,1.7-0.2,3.8-0.2,6.3c0,4.5,1.2,8.6,5.2,10l27.8,11.5l49.2-20.4l-5.2-1.9v-11l5.2-2.2l-8-3v-9.6L90.6,36.3
        z M13.8,30.3l27.8,10.9l39.9-16.1v8.6L41.6,50.3l-27.8-11V30.3z M81.3,64.8L41.4,81.3l-27.9-11v-7.8l24.9,10.2l43-17L81.3,64.8z
         M78.5,49.8L38.6,66.3l-27.8-11v-9l28.6,11.4l39.2-16.4L78.5,49.8L78.5,49.8z"/>
                    <g>
        <path d="M118.7,57.5v6.3H141v3.1h-31.9V42H141v9.7c0,3.2-2.6,5.7-5.8,5.7H118.7z M118.7,54.5h8.9c2.1,0,3.8-1.7,3.8-3.8v-5.6h-12.7
            V54.5z"/>
                        <path d="M144.9,46.7h14.7v3h-14.7V46.7z"/>
                        <path d="M197.3,28.5v10.9c0,2.5-1,4.6-2.4,6.1h2.4v13.7c0,4.2-3.4,7.7-7.6,7.7h-25.8V28.5H197.3z M182.7,45.5c3.3-0.2,5-3.1,5-5.3
            v-8.6h-14.3v13.9H182.7z M183.9,63.8c2.1,0,3.8-1.7,3.8-3.8V48.6h-14.3v15.2H183.9z"/>
                        <path d="M201.3,41.8h30.9V59c0,4.2-3.4,7.7-7.6,7.7h-23.2V41.8z M210.9,44.8v18.8h7.9c2.1,0,3.8-1.7,3.8-3.8v-15H210.9z"/>
                        <path d="M236.2,41.8h30.9V59c0,4.2-3.4,7.7-7.6,7.7h-23.2V41.8z M245.8,44.8v18.8h7.9c2.1,0,3.8-1.7,3.8-3.8v-15H245.8z"/>
                        <path d="M300,42l-10.2,12.2l11,12.6h-9.9l-10.1-11.7v11.7h-9.6V28.8h9.6v24.4l9.4-11.2H300z"/>
                        <path d="M322.3,27.5l-2.5,6.5H342v3.2h-23.5l-2.8,7.2h1.8V67h-10.2V52.5h-5.1l5.9-15.3h-5.8v-3.2h7.1l2.5-6.5H322.3z M335.6,40.4
            v7.4h5.1V51h-5.1v12.7h6.5v3.2h-23.1v-3.2h6.5V51h-5.1v-3.2h5.1v-7.4H335.6z"/>
                        <path d="M344.3,63.7l14.2-1v3.2l-14.2,1V63.7z M358.4,27.3l-3.1,12.4h3.6L355.2,57h3.2v3.2h-13.6l3.4-14h-3.6l4.7-18.9H358.4z
             M361,39.1l4.9-0.8l-2.5-10.9h9.7l2.1,9.3l8.9-1.6v3.4l-8.1,1.4l1.3,5.6l6.8-1.2v3.4l-6,1.1l1.2,5.1l4.9-2.6v4l-4,2.1l1.5,6.5h2.5
            v3.2h-11.6l-1.2-5.1l-9.5,5v-4l8.6-4.5l-1.8-8.1l-7.6,1.3v-3.4l6.9-1.2l-1.3-5.7l-5.6,1V39.1z M376.7,33.8l-1.3-5.8h7.3l1.3,5.8
            H376.7z"/>
                        <path d="M423.5,27.8l2.4,8.4h-3.4V47h3.4v14.2c0,2.2-1.8,4-4,4h-9.6v-3.2h2.4c0.7,0,1.2-0.5,1.2-1.2V50.2h-8.6v17h-10v-17h-10.9V47
            h10.9V35.1h-8.9v-3.2h8.9v-4.5h10v4.5h6.8l-1.2-4.2H423.5z M407.3,35.1V47h5.2V35.1H407.3z"/>
                        <path d="M438.1,34.4v32.6h-9.6V31.3h18v-3.8h10v3.8h11.3v3.2H438.1z M457.6,36.3v5.3h10.2v3.2h-10.2v5.8h9.5v12.5
            c0,2.1-1.8,3.9-4,3.9h-23.4V50.6h7.9V36.3H457.6z M457.3,53.8h-7.7v10.1h6.5c0.7,0,1.2-0.5,1.2-1.2V53.8z"/>
    </g>
    </svg>
            </div>
            <el-menu mode="horizontal" router="router" active-text-color="#409EFF">
                <!-- FIX ME -->
                <el-menu-item  v-for="nav in navList.filter(nav => display(nav))" :index="nav.url" :route="redirect(nav)" class="header-item"  v-bind:class="{'nav-selected': selected(nav.url)}" :key="nav.url">
                    {{nav.name}}
                </el-menu-item>
            </el-menu>
        </div>
        <div class="header-right">
            <el-menu mode="horizontal" router="router" active-text-color="#409EFF">
                <el-submenu index="2" v-bind:class="{'nav-selected': selected('right')}">
                    <template slot="title">{{!this.loggedIn ? "我的" : this.username}}</template>
                    <el-menu-item index="/login" :route="{path: '/login', query: {redirect: getRedirectURL()}}" v-if="!this.loggedIn">登录</el-menu-item>
                    <el-menu-item index="/register" :route="{path: '/register', query: {redirect: getRedirectURL()}}" v-if="!this.loggedIn">注册</el-menu-item>
                    <el-menu-item index="" v-if="this.loggedIn" v-on:click="logout">退出登录</el-menu-item>
                </el-submenu>
            </el-menu>
        </div>
    </div>
</template>

<script>
    import navList from "../data/nav_list.json";
    import Api from "@/components/Api.js";

    export default {
        name: "Header",
        data() {
            return {
                navList: navList,
            }
        },
        computed: {
            username () {
                return this.$store.state.user.username;
            },
            admin() {
                return this.$store.state.user.admin;
            },
            path () {
                return this.$route.path;
            },
            loggedIn() {
                return this.username != null && this.username !== "";
            }
        },
        methods: {
            display(nav) {
                switch (nav.name) {
                    case "图书列表":
                        return this.$route.path.split("/")[1] === "list";
                    case "图书详情":
                        return this.$route.path.split("/")[1] === "info";
                    case "购物车":
                    case "已购":
                        return this.loggedIn;
                    case "用户管理":
                    case "添加书籍":
                    case "书籍管理":
                    case "销量管理":
                    case "订单管理":
                        return this.admin;
                    case "编辑书籍":
                        return this.admin && this.$route.path.split("/")[2] === "edit";
                    case "注册":
                    case "登录":
                        return false;
                    default:
                        return true;
                }
            },
            redirect(nav) {
                if (nav.name === "图书列表" || nav.name === "图书详情") {
                    return this.$route.fullPath;
                } else {
                    return nav.url;
                }
            },
            selected(url) {
                if (url === "right") {
                    return this.$route.path === "/login" || this.$route.path === "/register";
                }
                return this.$route.path.indexOf(url) !== -1;
            },
            logout() {
                Api.Logout();
                this.$store.commit("logout");
                this.$router.push("/");
            },
            getRedirectURL() {
                if (this.$route.fullPath === "/register" || this.$route.fullPath === "/login") {
                    return "/";
                }
                if (this.$route.query.redirect) {
                     return this.$route.query.redirect;
                }
                return this.$route.fullPath;
            }
        },
        mounted() {
            Api.GetUsername().then(
                response => {
                    console.log(response.data);
                    let username = response.data.username;
                    let admin = response.data.admin === 1;
                    let root = response.data.root === 1;
                    this.$store.commit("login", {username:username, admin:admin, root:root});
                }, error => {
                    switch (error.response.data.status) {
                        case 401:
                            this.$store.commit("login", {username:"", admin:false, root:false});
                            break;
                        default:
                            this.$notify({
                                title: "错误",
                                message: "未知错误",
                                type: "error"
                            });
                            break;
                    }
                }
            );
        }
    }
</script>

<style scoped>
    .header {
        display: flex;
        justify-content: space-between;
    }

    .header-left {
        display: flex;
    }
    .logo {
        margin-top: 15px;
    }
    #logo-svg {
        height: 30px;
        fill: #409EFF;
    }
</style>

<style>
    .nav-selected {
        border-bottom: 2px solid #409EFF !important;
    }

    .el-menu-item, .el-submenu__title, .el-submenu__title i {
        color: #3c89f2 !important;
    }

    .el-menu.el-menu--horizontal:not(.nav-selected) {
        border-bottom: none !important;
    }

    .el-menu--horizontal>.el-submenu .el-submenu__title {
        border-bottom: none !important;
    }

    .el-menu--horizontal>.el-menu-item:not(.nav-selected) {
        border-bottom: none !important;
    }
</style>
